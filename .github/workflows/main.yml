name: DevSecOps CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¬ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ§  Install SonarQube Scanner
      run: |
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
        unzip sonar-scanner-cli-5.0.1.3006-linux.zip
        sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
        sudo ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner

    - name: ğŸ§ª SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=react-app \
          -Dsonar.sources=. \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}


    - name: ğŸ³ Build Docker image
      run: docker build -t react-app:latest .

    - name: ğŸ•µï¸ Trivy Scan
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
        sudo mv ./bin/trivy /usr/local/bin/trivy
        trivy --version  # Optional: to verify installation
        trivy image react-app:latest

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: ğŸ”‘ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: ğŸš¢ Tag and Push Docker Image to ECR
      env:
        ECR_REPOSITORY: react-app
      run: |
        docker tag react-app:latest ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
        docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

    - name: ğŸš€ Deploy to ECS
      run: |
        aws ecs update-service \
          --cluster react-cluster \
          --service react-service \
          --force-new-deployment \
          --region us-east-1

    - name: ğŸ“¬ Send SNS Notification
      run: |
        aws sns publish \
          --topic-arn arn:aws:sns:us-east-1:${{ secrets.AWS_ACCOUNT_ID }}:deploy-alerts \
          --subject "ğŸš€ New Deployment Completed" \
          --message "The latest version of the React app has been deployed successfully to ECS Fargate."

####
